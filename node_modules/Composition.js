//Composition.js
//Very important part of the engine. Implements a Component Entity System
//http://www.wikipedia.org/en/Entity_component_system
//http://gameprogrammingpatterns.com/component.html

/*
A component system is basically a system when every game object
is made up of small components that each perform separate tasks.
Components have access to other components inside the same gameobject
and may work together. If you need, for example, a slight variation
for a game object, you need only create another game object with
slightly different components. This helps organize better the game.
Read URLs above for a better understanding of a component system.

What makes the Composition.js system different from a traditional
component system is that components may contain other components.
Compositions only have access to their sister and children
compositions, and have no access to the parent composition.
This makes it so that a game object will also be a composition,
which as the name suggests is a compilation of many components.

Ex.
A player composition for example may have a rigidbody component (for physics),
a collider component (collision detection), and a renderer
component. The rigidbody component can then communicate with the
collision component to determine if a collision occured.

Compositions should be used when you need to do something each
frame update or every frame's draw call. Examples include moving
a character, calculating physics, rendering terrain, etc.
Compositions should not be used when you only want to store some
variables or helper functions. Normal javascript objects should be
used instead.

Current methods that compositions may implement are start(), update(),
draw(), and end() function. Refer to Engine.js to see when these functions
are called.

TODO:
Si tenemos tiempo igual y hacer un sistema de mensajes aqui para usarlo
por ejemplo que si le pican space que se mande un mensaje desde algun
composition KeyboardInput a los dem√°s compositions.

*/


module.exports = (function(){

	//Constructor for Composition class
	/*
		Arguments for Composition must follow the following format:
		Ex.

		Composition("player", player);

		The string "player" refers to composition's identifier, which may be used by neighbour compositions to access it.
	*/

	function Composition(){
		this.components = {};

		//Since 'arguments' is in the format ["name0",composition0, "name1", composition1, ...],
		//we use each name and composition as a key-value pair inside the 'this.components' object.

		for (var i = 0; i < arguments.length/2; i++) {
			this.components[arguments[i*2]] = arguments[i*2+1];
		}

		this.propagate = function(name, args){
			if(this[name] != undefined){
				this[name].apply(this, args);
			}
			for(key in this.components){
				this.components[key].base = this.components;
				this.components[key].propagate.apply(this.components[key], [name, args]);
			}
		}

		// //Backend start function. Calls this.start if defined and start functions inside components object.
		// this._start = function(){
		// 	if(this.start != undefined){
		// 		this.start.apply(this, arguments);
		// 	}
		// 	for(key in this.components){
		// 		this.components[key].base = this.components;
		// 		this.components[key]._start.apply(this.components[key], arguments);
		// 	}
		// }

		// this._clear = function(){
		// 	if(this.clear != undefined){
		// 		this.clear.apply(this,arguments);
		// 	}
		// 	for(key in this.components){
		// 		this.components[key].base = this.components;
		// 		this.components[key]._clear.apply(this.components[key], arguments);
		// 	}
		// }

		// //Backend udpdate function. Calls this.update if defined and update functions inside components object.
		// this._update = function(){
		// 	if(this.update != undefined){
		// 		this.update.apply(this, arguments);
		// 	}
		// 	for(key in this.components){
		// 		this.components[key].base = this.components;
		// 		this.components[key]._update.apply(this.components[key], arguments);
		// 	}
		// }

		// //Backend draw function. Calls this.draw if defined and draw functions inside components object.
		// this._draw = function(){
		// 	if(this.draw != undefined){
		// 		this.draw.apply(this, arguments);
		// 	}
		// 	for(key in this.components){
		// 		this.components[key].base = this.components;
		// 		this.components[key]._draw.apply(this.components[key], arguments);
		// 	}
		// }

		// //Backend end function. Calls this.end if defined and end functions inside components object.
		// this._end = function(){
		// 	if(this.end != undefined){
		// 		this.end.apply(this, arguments);
		// 	}
		// 	for(key in this.components){
		// 		this.components[key].base = this.components;
		// 		this.components[key]._end.apply(this.components[key],arguments);
		// 	}
		// }
	}

	return Composition;
})();
