var Composition = require('Composition');
var Transform = require('Transform');
var ImageRenderer = require('ImageRenderer');
var Rigidbody = require('Rigidbody');
var characterCollider = require('CharacterCollider');
var CharacterController = require('CharacterController');
var gravity = require('Gravity');
var Vec2 = require('vec2');
var LifeComponent = require("LifeComponent");
var LifeBar = require('LifeBar');
var StepBar = require('StepBar');
var SpellBall = require('SpellBall');
var RadialSlider = require('RadialSlider');
var playAudio = require('playAudio');
var GameScore = require('GameScore');
var Timer = require('Timer');
var dataIO = require('dataIO')

module.exports = function(x, y, path){

	var player = new Composition(
		'transform', Transform(x,y),
		'controller', CharacterController(),
		'rigidbody', Rigidbody(),
		'collider', characterCollider(),
		'renderer', ImageRenderer(path, -4),
		'gravity', gravity(100),
		'life', LifeComponent(),
		'steps', LifeComponent(),
		'time', LifeComponent(),
		'LifeBar', LifeBar(),
		'StepBar', StepBar(),
		'Timer', Timer(20, this),
		'GameScore', GameScore()
	);

	player.setActive = function(value){
		//Make it so that player can no longer move
		this.components.rigidbody.speed = new Vec2(0,0);
		this.components.controller.active = value;
		this.components.Timer.active = value;

		//Flag that determines current player
		this.isActive = value;

		if(value){
			//Add radial sliders to active players
			this.add("radialSlider", RadialSlider());
		}else{
			//Remove radial sliders from inactive players
			if(this.components.radialSlider!=null){
				this.components.radialSlider.destroy();
			}
		}
	}

	player.endTurn = function(){
		this.components.steps.percentage = 1;
		this.components.time.percentage = 1;
		this.components.Timer.timeSpent = 0;
		this.base.turnManager.nextTurn();

	}

	//Throws spell ball
	player.castSpell = function(initVel){
		//Create SpellBall
		var spell = SpellBall(this, initVel)

		//Set initial conditions
		spell.components.transform.localPosition = this.components.transform.position.clone();
		spell.components.transform.localPosition.x += (this.components.renderer.image.width/2);
		spell.components.transform.localPosition.y += (this.components.renderer.image.height/2);

		//Add spell to player
		this.add('spell', spell);

		this.setActive(false);
	}

	var timeClicked = 0;
	var shouldCount = false;

	player.keydown = function(keycode){
		if(keycode == 32){
			if(this.isActive){
				shouldCount = true;
			}
		}
	}

	player.keyup = function(keycode){
		if(keycode == 32){
			if(this.isActive){
				var initVel = this.components.radialSlider.components.handle.components.transform.localPosition.clone();
				var velFactor = timeClicked * 1.5;
				initVel.multiply(velFactor);
				this.castSpell(initVel);
				shouldCount = false;
				timeClicked = 0;
			}
		}
	}

	player.update = function(deltaTime){
		if((this.components.steps.percentage <= 0) || (this.components.time.percentage <= 0)){
			this.endTurn();
		}
		if(shouldCount && timeClicked < 2){
			timeClicked += deltaTime;
			this.components.radialSlider.radius = 50 +  (timeClicked * 20);
		}
		if(this.components.life.percentage <= 0.01){
			this.destroy();
		}
	}

	player.exit = function(){
		this.base.turnManager.removePlayer(this);
		this.base.collisionManager.removePlayer(this);

		var data = dataIO.readFile();
		for(var i = 0; i < data.players.length; i++){
			if(data.players[i].name == this.name){
				if(data.players[i].highscore < this.components.GameScore.score){
					data.players[i].highscore = this.components.GameScore.score;
				}
			}
		}
		dataIO.writeFile(data);
	}
	player.win = function(){
		this.components.GameScore.addLife(this.components.life.percentage);
	}

	return player;
}
