var Composition = require('Composition');
var Transform = require('Transform');
var ImageRenderer = require('ImageRenderer');
var rigidbody = require('Rigidbody');

var player = new Composition(
	'transform', Transform(100,100),
	'rigidbody', rigidbody,
	'renderer', ImageRenderer("resources/player.png", 1)
);

player.start = function(){
	this.components.rigidbody.acceleration.y = 100;
	this.components.rigidbody.speed.x = 10;
}

player.update = function(timeDelta){
	var terrainHeightAtX = getTerrainHeight(this.components.transform.localX);

	if(terrainHeightAtX < this.components.transform.localY){
		this.components.rigidbody.speed.y = 0;
		this.components.transform.localY = terrainHeightAtX - (this.components.transform.localY-terrainHeightAtX);
	}

}

var getTerrainHeight = function(x){
	var imgData = player.base.terrain.components.renderer.canvas.context.getImageData(0, 0, 800, 500);
	for(var i = Math.ceil(x)*4; i < imgData.data.length; i+=3200){
		if(imgData.data[i+3]!=0){
			return (i-Math.ceil(x)*4)/3200;
		}
	}
}

module.exports = player;
