var Composition = require('Composition');

var CharacterCollider = new Composition();

console.log(JSON.stringify(CharacterCollider));

CharacterCollider.update = function(){
	
	var terrainHeightAtX = getTerrainHeight(this.base.transform.localX);
	console.log(JSON.stringify(terrainHeightAtX));

	if(terrainHeightAtX < this.base.transform.localY + this.base.renderer.image.height){
		this.base.rigidbody.speed.y = 0;
		this.base.transform.localY = terrainHeightAtX - (this.base.transform.localY + this.base.renderer.image.height -terrainHeightAtX);
	}
	console.log(JSON.stringify(this.base.transform.localY));
}

var getTerrainHeight = function(x, y){
	//Basicamente lo que trato de hacer es encontrar el pixel del terrain mas alto para una x dada.
	//Seguramente el for está mal
	//Considera que el origen está en la esquina superior derecha. Osea entre mas grande y mas bajo.
	//Busca en internet canvas.getImageData para que veas como esta el array.
	var imgData = engine.find("terrain").components.renderer.canvas.context.getImageData(0, 0, 800, 500);
	for(var i = Math.ceil(x)*4; i < imgData.data.length; i+=3200){
		if(imgData.data[i+3]!=0){
			return (i-Math.ceil(x)*4)/3200;
		}
	}
}

module.exports =  CharacterCollider;